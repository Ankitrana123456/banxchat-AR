<!doctype html>
<html>
<head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>BAN X CHAT — Admin</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
<style>
body{font-family:"Poppins",sans-serif;margin:0;background:#f3f5f8;color:#122}
.container{max-width:1100px;margin:18px auto;padding:12px}
.header{display:flex;align-items:center;gap:12px}
.card{background:#fff;padding:12px;border-radius:10px;box-shadow:0 8px 20px rgba(12,20,40,0.06);margin-top:12px}
.grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
.table{width:100%;border-collapse:collapse}
.table th, .table td{padding:8px;border-bottom:1px solid #eee}
.btn{padding:8px 10px;border-radius:8px;border:0;background:#0a84ff;color:#fff;cursor:pointer}
.alert{color:#e53935}
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <div style="font-weight:700;font-size:20px">BAN X CHAT — Admin Panel</div>
    <div style="margin-left:auto"><button id="logout" class="btn">Logout</button></div>
  </div>

  <div class="grid">
    <div class="card" id="statsCard">
      <h3>Stats</h3>
      <div>Total users: <span id="totalUsers">0</span></div>
      <div>Online now: <span id="onlineNow">0</span></div>
      <div>Total groups: <span id="groupsCount">0</span></div>
      <div>Total messages (approx): <span id="msgCount">0</span></div>
    </div>

    <div class="card">
      <h3>Users</h3>
      <table class="table" id="usersTable"><thead><tr><th>Name</th><th>Email</th><th>Online</th><th>Role</th><th>Action</th></tr></thead><tbody></tbody></table>
    </div>

    <div class="card">
      <h3>Official Channel</h3>
      <textarea id="channelMsg" rows="4" style="width:100%"></textarea><br/>
      <button id="postChannel" class="btn">Post to Official Channel</button>
    </div>
  </div>

  <div class="card">
    <h3>Recent Logs / Actions</h3>
    <div id="logs" style="max-height:240px;overflow:auto"></div>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="firebase-config.js"></script>

<script>
const auth = firebase.auth(), db = firebase.firestore();
auth.onAuthStateChanged(async user => {
  if(!user) return location.href='index.html';
  // check role in users doc
  const doc = await db.collection('users').doc(user.uid).get();
  const data = doc.data() || {};
  if(data.role !== 'admin') return document.body.innerHTML = '<div style="padding:20px">Access denied: not admin.</div>';
  loadStats();
  loadUsers();
});

async function loadStats(){
  const usersSnap = await db.collection('users').get(); document.getElementById('totalUsers').innerText = usersSnap.size;
  const online = usersSnap.docs.filter(d=>d.data().online).length; document.getElementById('onlineNow').innerText = online;
  const groupsSnap = await db.collection('groups').get(); document.getElementById('groupsCount').innerText = groupsSnap.size;
  // approximate msg count
  let totalMsgs = 0;
  const convos = await db.collection('convos').get();
  for(const c of convos.docs){
    const msgsSnap = await db.collection('convos').doc(c.id).collection('msgs').get();
    totalMsgs += msgsSnap.size;
  }
  document.getElementById('msgCount').innerText = totalMsgs;
}

async function loadUsers(){
  const snap = await db.collection('users').get();
  const tb = document.querySelector('#usersTable tbody'); tb.innerHTML='';
  snap.forEach(d=>{
    const data = d.data();
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${data.name||''}</td><td>${data.email||''}</td><td>${data.online? 'Yes':'No'}</td><td>${data.role||'user'}</td>
      <td><button class="btn" onclick="makeAdmin('${d.id}')">Make Admin</button> <button class="btn" onclick="banUser('${d.id}')">Ban</button></td>`;
    tb.appendChild(tr);
  });
}

async function makeAdmin(uid){
  await db.collection('users').doc(uid).update({ role:'admin' });
  alert('Made admin: ' + uid); loadUsers();
}
async function banUser(uid){
  if(!confirm('Ban user?')) return;
  await db.collection('users').doc(uid).update({ banned:true });
  alert('User banned');
}
document.getElementById('postChannel').addEventListener('click', async ()=>{
  const txt = document.getElementById('channelMsg').value.trim(); if(!txt) return alert('Type message');
  const msgRef = db.collection('channels').doc('official').collection('msgs');
  await msgRef.add({ fromAdmin: true, text: txt, ts: Date.now() });
  alert('Posted to official channel');
  document.getElementById('channelMsg').value='';
});
document.getElementById('logout').addEventListener('click', async ()=> { await auth.signOut(); location.href='index.html' });
</script>
</body>
  </html>
